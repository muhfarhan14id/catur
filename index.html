<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catur Pro - Advisor Interaktif</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --panel: #161616;
            --board-light: #eaecd0;
            --board-dark: #779455;
            --accent: #00d2ff;
            --danger: #ff4b2b;
            --text: #e0e0e0;
            --square-size: 70px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }

        body {
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            max-width: 1100px;
            width: 100%;
            justify-content: center;
        }

        /* Fixed Board Logic */
        .board-container {
            width: 560px;
            flex-shrink: 0; /* Mencegah penyusutan */
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 70px);
            grid-template-rows: repeat(8, 70px);
            width: 560px;
            height: 560px;
            border: 5px solid #333;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            position: relative;
        }

        .square {
            width: 70px;
            height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .square.light { background-color: var(--board-light); }
        .square.dark { background-color: var(--board-dark); }
        .square.selected { background-color: rgba(0, 210, 255, 0.5) !important; }
        .square.last-move { background-color: rgba(255, 255, 0, 0.3) !important; }
        .square.check { background-color: var(--danger) !important; }
        .square.hint-target { box-shadow: inset 0 0 0 4px var(--accent); }

        .piece { width: 90%; height: 90%; z-index: 5; pointer-events: none; }
        .piece svg { width: 100%; height: 100%; }

        .legal-dot {
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
        }

        /* Advisor Panel */
        .advisor-panel {
            flex: 1;
            min-width: 350px;
            background: var(--panel);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 1px solid #222;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--accent);
            text-transform: uppercase;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .eval-bar-wrapper {
            background: #222;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            margin: 10px 0;
        }
        #eval-w { background: white; width: 50%; transition: width 0.5s; }
        #eval-b { background: #000; width: 50%; transition: width 0.5s; }

        .suggestion-box {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        .suggestion-box:hover { border-color: var(--accent); background: #222; }
        .suggestion-box.active { border-color: var(--accent); background: #003344; }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
        }
        .btn-main { background: var(--accent); color: #000; width: 100%; }
        .btn-reset { background: #333; color: #fff; width: 100%; }

        #status-msg {
            font-weight: bold;
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .board-container { width: 320px; }
            .board { grid-template-columns: repeat(8, 40px); grid-template-rows: repeat(8, 40px); width: 320px; height: 320px; }
            .square { width: 40px; height: 40px; }
            .main-container { padding: 10px; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- Board Section -->
        <div class="board-section">
            <div id="status-msg">Giliran: Putih</div>
            <div class="board-container">
                <div id="board" class="board"></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-reset" onclick="resetGame()">Reset</button>
                <button id="btn-execute" class="btn btn-main" style="display: none;" onclick="executeSuggested()">Eksekusi Saran</button>
            </div>
        </div>

        <!-- Advisor Section -->
        <div class="advisor-panel">
            <div>
                <div class="section-title">Keseimbangan Kekuatan</div>
                <div class="eval-bar-wrapper">
                    <div id="eval-w"></div>
                    <div id="eval-b"></div>
                </div>
                <div id="eval-text" style="text-align: center; font-size: 0.8rem;">Analisis Netral (0.0)</div>
            </div>

            <div>
                <div class="section-title">Ancaman AI (25% Skill)</div>
                <div id="threat-log" style="font-size: 0.85rem; color: var(--danger);">Tidak ada ancaman terdeteksi.</div>
            </div>

            <div>
                <div class="section-title">Pilih Saran Langkah</div>
                <div id="suggestion-list" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- Dihasilkan oleh JS -->
                </div>
            </div>

            <div style="margin-top: auto; padding: 10px; background: #000; border-radius: 6px; font-size: 0.8rem;">
                <strong>Panduan:</strong> Klik kotak pada papan atau pilih salah satu kotak saran di atas. Saran akan menyoroti langkah terbaik untuk menyerang AI.
            </div>
        </div>
    </div>

    <script>
        /**
         * GAME LOGIC
         */
        const PIECES = {
            empty: 0,
            wP: 1, wN: 2, wB: 3, wR: 4, wQ: 5, wK: 6,
            bP: 7, bN: 8, bB: 9, bR: 10, bQ: 11, bK: 12
        };

        const PIECE_SVG = {
            wP: '<svg viewBox="0 0 45 45"><path d="M22.5 9c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.38C17.33 16.5 16 18.59 16 21c0 2.03.94 3.84 2.41 5.03-3 1.06-7.41 5.55-7.41 13.47h23c0-7.92-4.41-12.41-7.41-13.47 1.47-1.19 2.41-3 2.41-5.03 0-2.41-1.33-4.5-3.28-5.62.49-.67.78-1.49.78-2.38 0-2.21-1.79-4-4-4z" fill="#fff" stroke="#000" stroke-width="1.5"/></svg>',
            wN: '<svg viewBox="0 0 45 45"><path d="M22 10c10.5 1 16.5 8 16 29H15c0-9 10-6.5 8-21" fill="#fff" stroke="#000" stroke-width="1.5"/><path d="M24 18c.38 2.43-1.61 1.24-2.15 1.57-.59.35-.11 1.48.5 1.29 1.07-.35 2.14-.52 2.65-1.14.31-.38.11-1.4-.41-1.92-.37-.36-1.19-.36-1.4-.23-.21.13-.19.43.04.59.23.16.58.16.77.21.19.05.21.37.04.42-.17.05-.33-.2-.54-.23-.21-.03-.47.16-.41.34s.38.12.63.14c.25.02.48.42.25.54-.23.12-.52-.14-.7-.09-.18.05-.2.43.04.53.24.1.61-.1.87-.04.26.06.41.42.22.55-.19.13-.57-.1-.77-.04-.2.06-.2.41.04.51.24.1.61-.1.87-.04.26.06.41.42.22.55-.19.13-.57-.1-.77-.04-.2.06-.2.41.04.51" fill="#fff" stroke="#000" stroke-width="1.5"/></svg>',
            wB: '<svg viewBox="0 0 45 45"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><g fill="#fff"><path d="M9 36c3.39-.97 10.11.43 13.5-2 3.39 2.43 10.11 1.03 13.5 2 0 0 1.65.54 3 2-.68.97-1.65.99-3 .54-3.39-.97-10.11.46-13.5-2-3.39 2.46-10.11 1.03-13.5 2-1.35.45-2.32.43-3-.54 1.35-1.46 3-2 3-2z"/><path d="M15 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11 4-10.5 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2z"/><path d="M25 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z"/></g><path d="M17.5 26h10M15 30h15m-7.5-14.5v5M20 18h5" stroke-linejoin="miter"/></g></svg>',
            wR: '<svg viewBox="0 0 45 45"><g fill="#fff" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 39h27v-3H9v3zM12 36v-4h21v4H12zM11 14V9h4v2h5V9h5v2h5V9h4v5" stroke-linecap="butt"/><path d="M34 14l-3 3H14l-3-3"/><path d="M31 17v12.5H14V17" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M31 29.5l1.5 2.5h-20l1.5-2.5"/><path d="M11 14h23" fill="none" stroke-linejoin="miter"/></g></svg>',
            wQ: '<svg viewBox="0 0 45 45"><g fill="#fff" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM24.5 7.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM41 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM11 20a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM38 20a2 2 0 1 1-4 0 2 2 0 1 1 4 0z"/><path d="M9 26c8.5-1.5 21-1.5 27 0l2-12-7 11V11l-5.5 13.5-3-15-3 15-5.5-13.5V25L7 14l2 12z"/><path d="M9 26c0 2 1.5 2 2.5 4 2.5 4 17 4 19.5 4 1 0 2.5-2 2.5-4-8.5-1.5-18.5-1.5-24.5 0z" stroke-linecap="butt"/><path d="M11.5 30c3.5-1 18.5-1 22 0M12 33.5c6-1 15-1 21 0" fill="none"/><path d="M9 39h27v-3H9v3z" stroke-linecap="butt"/></g></svg>',
            wK: '<svg viewBox="0 0 45 45"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22.5 11.63V6M20 8h5" stroke="#000" stroke-linejoin="miter"/><path d="M22.5 25s4.5-7.5 4.5-11.08c0-2.45-2.02-4.42-4.5-4.42s-4.5 1.97-4.5 4.42c0 3.58 4.5 11.08 4.5 11.08z" fill="#fff" stroke-linecap="butt"/><path d="M11.5 37c5.5 3.5 15.5 3.5 21 0v-7s9-4.5 6-10.5c-4-1-1-4-6-4h-22c-5 0-2 3-6 4-3 6 6 10.5 6 10.5v7z" fill="#fff"/><path d="M11.5 30c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0" stroke="#000"/><path d="M9 39h27v-3H9v3z" fill="#fff" stroke-linecap="butt"/></g></svg>',
            bP: '<svg viewBox="0 0 45 45"><path d="M22.5 9c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.38C17.33 16.5 16 18.59 16 21c0 2.03.94 3.84 2.41 5.03-3 1.06-7.41 5.55-7.41 13.47h23c0-7.92-4.41-12.41-7.41-13.47 1.47-1.19 2.41-3 2.41-5.03 0-2.41-1.33-4.5-3.28-5.62.49-.67.78-1.49.78-2.38 0-2.21-1.79-4-4-4z" fill="#000" stroke="#fff" stroke-width="1.5"/></svg>',
            bN: '<svg viewBox="0 0 45 45"><path d="M22 10c10.5 1 16.5 8 16 29H15c0-9 10-6.5 8-21" fill="#000" stroke="#fff" stroke-width="1.5"/><path d="M24 18c.38 2.43-1.61 1.24-2.15 1.57-.59.35-.11 1.48.5 1.29 1.07-.35 2.14-.52 2.65-1.14.31-.38.11-1.4-.41-1.92-.37-.36-1.19-.36-1.4-.23-.21.13-.19.43.04.59.23.16.58.16.77.21.19.05.21.37.04.42-.17.05-.33-.2-.54-.23-.21-.03-.47.16-.41.34s.38.12.63.14c.25.02.48.42.25.54-.23.12-.52-.14-.7-.09-.18.05-.2.43.04.53.24.1.61-.1.87-.04.26.06.41.42.22.55-.19.13-.57-.1-.77-.04-.2.06-.2.41.04.51.24.1.61-.1.87-.04.26.06.41.42.22.55-.19.13-.57-.1-.77-.04-.2.06-.2.41.04.51" fill="#000" stroke="#fff" stroke-width="1.5"/></svg>',
            bB: '<svg viewBox="0 0 45 45"><g fill="none" fill-rule="evenodd" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><g fill="#000"><path d="M9 36c3.39-.97 10.11.43 13.5-2 3.39 2.43 10.11 1.03 13.5 2 0 0 1.65.54 3 2-.68.97-1.65.99-3 .54-3.39-.97-10.11.46-13.5-2-3.39 2.46-10.11 1.03-13.5 2-1.35.45-2.32.43-3-.54 1.35-1.46 3-2 3-2z"/><path d="M15 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11 4-10.5 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2z"/><path d="M25 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z"/></g><path d="M17.5 26h10M15 30h15m-7.5-14.5v5M20 18h5" stroke-linejoin="miter"/></g></svg>',
            bR: '<svg viewBox="0 0 45 45"><g fill="#000" fill-rule="evenodd" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 39h27v-3H9v3zM12 36v-4h21v4H12zM11 14V9h4v2h5V9h5v2h5V9h4v5" stroke-linecap="butt"/><path d="M34 14l-3 3H14l-3-3"/><path d="M31 17v12.5H14V17" stroke-linecap="butt" stroke-linejoin="miter"/><path d="M31 29.5l1.5 2.5h-20l1.5-2.5"/><path d="M11 14h23" fill="none" stroke-linejoin="miter"/></g></svg>',
            bQ: '<svg viewBox="0 0 45 45"><g fill="#000" fill-rule="evenodd" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM24.5 7.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM41 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM11 20a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM38 20a2 2 0 1 1-4 0 2 2 0 1 1 4 0z"/><path d="M9 26c8.5-1.5 21-1.5 27 0l2-12-7 11V11l-5.5 13.5-3-15-3 15-5.5-13.5V25L7 14l2 12z"/><path d="M9 26c0 2 1.5 2 2.5 4 2.5 4 17 4 19.5 4 1 0 2.5-2 2.5-4-8.5-1.5-18.5-1.5-24.5 0z" stroke-linecap="butt"/><path d="M11.5 30c3.5-1 18.5-1 22 0M12 33.5c6-1 15-1 21 0" fill="none"/><path d="M9 39h27v-3H9v3z" stroke-linecap="butt"/></g></svg>',
            bK: '<svg viewBox="0 0 45 45"><g fill="none" fill-rule="evenodd" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22.5 11.63V6M20 8h5" stroke="#fff" stroke-linejoin="miter"/><path d="M22.5 25s4.5-7.5 4.5-11.08c0-2.45-2.02-4.42-4.5-4.42s-4.5 1.97-4.5 4.42c0 3.58 4.5 11.08 4.5 11.08z" fill="#000" stroke-linecap="butt"/><path d="M11.5 37c5.5 3.5 15.5 3.5 21 0v-7s9-4.5 6-10.5c-4-1-1-4-6-4h-22c-5 0-2 3-6 4-3 6 6 10.5 6 10.5v7z" fill="#000"/><path d="M11.5 30c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0" stroke="#fff"/><path d="M9 39h27v-3H9v3z" fill="#000" stroke-butt"/></g></svg>'
        };

        const PIECE_VALS = { 1:10, 2:30, 3:35, 4:50, 5:90, 6:1000, 7:-10, 8:-30, 9:-35, 10:-50, 11:-90, 12:-1000 };

        /**
         * CHESS CORE ENGINE
         */
        class ChessEngine {
            constructor() { this.reset(); }
            reset() {
                this.board = Array(64).fill(0);
                this.setup();
                this.turn = 'white';
                this.rights = { wK:1, wQ:1, bK:1, bQ:1 };
                this.ep = null;
                this.lastMove = null;
                this.over = false;
                this.history = [];
            }
            setup() {
                const l = ['bR','bN','bB','bQ','bK','bB','bN','bR','bP','bP','bP','bP','bP','bP','bP','bP',...Array(32).fill(0),'wP','wP','wP','wP','wP','wP','wP','wP','wR','wN','wB','wQ','wK','wB','wN','wR'];
                l.forEach((p, i) => { if(p) this.board[i] = PIECES[p]; });
            }
            getColor(p) { return p === 0 ? null : (p <= 6 ? 'white' : 'black'); }
            getType(p) { return p === 0 ? null : ['P','N','B','R','Q','K'][(p-1)%6]; }

            getMoves(idx, board = this.board) {
                const p = board[idx]; if(!p) return [];
                const color = this.getColor(p), type = this.getType(p), r = Math.floor(idx/8), c = idx%8;
                let moves = [];
                const add = (tr, tc, s = null) => {
                    if (tr >= 0 && tr < 8 && tc >= 0 && tc < 8) {
                        const tIdx = tr*8 + tc, tp = board[tIdx];
                        if (tp === 0 || this.getColor(tp) !== color) { moves.push({ from: idx, to: tIdx, special: s }); return tp === 0; }
                    } return false;
                };
                switch(type) {
                    case 'P':
                        let d = color === 'white' ? -1 : 1;
                        if(board[(r+d)*8+c] === 0) { add(r+d, c); if(((color==='white'&&r===6)||(color==='black'&&r===1)) && board[(r+2*d)*8+c] === 0) add(r+2*d, c); }
                        [-1, 1].forEach(dc => {
                            let tc = c+dc, tIdx = (r+d)*8+tc;
                            if(tc >= 0 && tc < 8 && ((board[tIdx] !== 0 && this.getColor(board[tIdx]) !== color) || tIdx === this.ep)) add(r+d, tc, tIdx === this.ep ? 'ep' : null);
                        });
                        break;
                    case 'N': [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(o => add(r+o[0], c+o[1])); break;
                    case 'B': [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(dir => { for(let i=1;i<8;i++) if(!add(r+dir[0]*i, c+dir[1]*i)) break; }); break;
                    case 'R': [[1,0],[-1,0],[0,1],[0,-1]].forEach(dir => { for(let i=1;i<8;i++) if(!add(r+dir[0]*i, c+dir[1]*i)) break; }); break;
                    case 'Q': [[1,1],[1,-1],[-1,1],[-1,-1],[1,0],[-1,0],[0,1],[0,-1]].forEach(dir => { for(let i=1;i<8;i++) if(!add(r+dir[0]*i, c+dir[1]*i)) break; }); break;
                    case 'K':
                        [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(o => add(r+o[0], c+o[1]));
                        if(!this.isAttacked(idx, color==='white'?'black':'white', board)) {
                            if(color==='white') {
                                if(this.rights.wK && board[61]===0 && board[62]===0 && !this.isAttacked(61, 'black', board)) moves.push({from:60, to:62, special:'castle'});
                                if(this.rights.wQ && board[59]===0 && board[58]===0 && board[57]===0 && !this.isAttacked(59, 'black', board)) moves.push({from:60, to:58, special:'castle'});
                            } else {
                                if(this.rights.bK && board[5]===0 && board[6]===0 && !this.isAttacked(5, 'white', board)) moves.push({from:4, to:6, special:'castle'});
                                if(this.rights.bQ && board[3]===0 && board[2]===0 && board[1]===0 && !this.isAttacked(3, 'white', board)) moves.push({from:4, to:2, special:'castle'});
                            }
                        }
                        break;
                }
                return moves.filter(m => {
                    const next = [...board]; this.execInternal(m, next);
                    const kIdx = next.indexOf(color==='white'?6:12);
                    return !this.isAttacked(kIdx, color==='white'?'black':'white', next);
                });
            }

            isAttacked(idx, attackerColor, b) {
                for(let i=0; i<64; i++) {
                    const p = b[i]; if(!p || this.getColor(p) !== attackerColor) continue;
                    const r = Math.floor(i/8), c = i%8, tr = Math.floor(idx/8), tc = idx%8, dr = Math.abs(r-tr), dc = Math.abs(c-tc);
                    const type = this.getType(p);
                    if(type === 'P') { if(dr === 1 && dc === 1 && tr === r + (attackerColor==='white'?-1:1)) return true; }
                    else if(type === 'N') { if((dr===2&&dc===1)||(dr===1&&dc===2)) return true; }
                    else if(type === 'K') { if(dr<=1 && dc<=1) return true; }
                    else {
                        const dirs = type==='B' ? [[1,1],[1,-1],[-1,1],[-1,-1]] : type==='R' ? [[1,0],[-1,0],[0,1],[0,-1]] : [[1,1],[1,-1],[-1,1],[-1,-1],[1,0],[-1,0],[0,1],[0,-1]];
                        for(let d of dirs) {
                            for(let s=1; s<8; s++) {
                                let nr = r+d[0]*s, nc = c+d[1]*s;
                                if(nr<0||nr>=8||nc<0||nc>=8) break;
                                if(nr===tr && nc===tc) return true;
                                if(b[nr*8+nc] !== 0) break;
                            }
                        }
                    }
                } return false;
            }

            execInternal(m, b) {
                const p = b[m.from]; b[m.to] = p; b[m.from] = 0;
                if(m.special === 'ep') b[this.getColor(p)==='white'?m.to+8:m.to-8] = 0;
                else if(m.special === 'castle') {
                    if(m.to===62) {b[61]=4; b[63]=0;} else if(m.to===58) {b[59]=4; b[56]=0;}
                    else if(m.to===6) {b[5]=10; b[7]=0;} else if(m.to===2) {b[3]=10; b[0]=0;}
                }
                if(this.getType(p)==='P' && (m.to<8||m.to>=56)) b[m.to] = this.getColor(p)==='white'?5:11;
            }

            move(m) {
                this.history.push({ b:[...this.board], r:{...this.rights}, ep:this.ep, turn:this.turn, lm:this.lastMove });
                const p = this.board[m.from];
                this.execInternal(m, this.board);
                if(p===6) this.rights.wK = this.rights.wQ = 0; if(p===12) this.rights.bK = this.rights.bQ = 0;
                if(m.from===56||m.to===56) this.rights.wQ=0; if(m.from===63||m.to===63) this.rights.wK=0;
                if(m.from===0||m.to===0) this.rights.bQ=0; if(m.from===7||m.to===7) this.rights.bK=0;
                this.ep = (this.getType(p)==='P' && Math.abs(m.from-m.to)===16) ? (m.from+m.to)/2 : null;
                this.turn = this.turn==='white'?'black':'white';
                this.lastMove = m;
                this.check();
            }

            check() {
                let moves = 0;
                for(let i=0; i<64; i++) if(this.getColor(this.board[i])===this.turn) moves += this.getMoves(i).length;
                if(moves === 0) { this.over = true; return this.isAttacked(this.board.indexOf(this.turn==='white'?6:12), this.turn==='white'?'black':'white', this.board) ? 'mate' : 'draw'; }
                return 'on';
            }

            eval(b = this.board) {
                let s = 0;
                b.forEach((p, i) => { if(p) s += PIECE_VALS[p]; });
                return s / 10;
            }

            minimax(d, a, b, isMax, board) {
                if(d===0) return this.eval(board);
                const turn = isMax ? 'white' : 'black';
                let moves = [];
                for(let i=0; i<64; i++) if(this.getColor(board[i])===turn) this.getMoves(i, board).forEach(m => moves.push(m));
                if(moves.length === 0) return this.isAttacked(board.indexOf(turn==='white'?6:12), isMax?'black':'white', board) ? (isMax?-9999:9999) : 0;
                if(isMax) {
                    let best = -Infinity;
                    for(let m of moves) { const next = [...board]; this.execInternal(m, next); best = Math.max(best, this.minimax(d-1, a, b, false, next)); a = Math.max(a, best); if(b<=a) break; }
                    return best;
                } else {
                    let best = Infinity;
                    for(let m of moves) { const next = [...board]; this.execInternal(m, next); best = Math.min(best, this.minimax(d-1, a, b, true, next)); b = Math.min(b, best); if(b<=a) break; }
                    return best;
                }
            }
        }

        /**
         * UI CONTROLLER
         */
        const engine = new ChessEngine();
        let selectedIdx = null;
        let activeSuggestion = null;

        function render() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            const checkIdx = engine.over ? -1 : (engine.isAttacked(engine.board.indexOf(engine.turn==='white'?6:12), engine.turn==='white'?'black':'white', engine.board) ? engine.board.indexOf(engine.turn==='white'?6:12) : -1);

            for(let i=0; i<64; i++) {
                const sq = document.createElement('div');
                sq.className = `square ${(Math.floor(i/8)+i%8)%2===0?'light':'dark'}`;
                if(engine.lastMove && (i===engine.lastMove.from || i===engine.lastMove.to)) sq.classList.add('last-move');
                if(i === selectedIdx) sq.classList.add('selected');
                if(i === checkIdx) sq.classList.add('check');
                if(activeSuggestion && (i === activeSuggestion.from || i === activeSuggestion.to)) sq.classList.add('hint-target');

                const p = engine.board[i];
                if(p) {
                    const div = document.createElement('div'); div.className = 'piece';
                    div.innerHTML = PIECE_SVG[Object.keys(PIECES).find(k => PIECES[k] === p)];
                    sq.appendChild(div);
                }

                if(selectedIdx !== null && engine.getMoves(selectedIdx).some(m => m.to === i)) {
                    const d = document.createElement('div'); d.className = 'legal-dot'; sq.appendChild(d);
                }

                sq.onclick = () => onSqClick(i);
                boardEl.appendChild(sq);
            }

            const state = engine.check();
            const msg = document.getElementById('status-msg');
            if(state === 'mate') { msg.innerText = "SKAKMAT!"; msg.style.color = "var(--danger)"; }
            else if(state === 'draw') msg.innerText = "DRAW / REMIS";
            else msg.innerText = `Giliran: ${engine.turn==='white'?'Putih':'Hitam'}`;

            updateAdvisor();

            if(!engine.over && engine.turn === 'black') setTimeout(makeAIMove, 600);
        }

        function onSqClick(i) {
            if(engine.over || engine.turn === 'black') return;
            if(selectedIdx === null) {
                if(engine.getColor(engine.board[i]) === 'white') selectedIdx = i;
            } else {
                const m = engine.getMoves(selectedIdx).find(move => move.to === i);
                if(m) { engine.move(m); selectedIdx = null; activeSuggestion = null; }
                else selectedIdx = (engine.getColor(engine.board[i]) === 'white') ? i : null;
            }
            render();
        }

        function makeAIMove() {
            let moves = [];
            for(let i=0; i<64; i++) if(engine.getColor(engine.board[i])==='black') engine.getMoves(i).forEach(m => moves.push(m));
            if(moves.length === 0) return;

            // Skill 25%
            let choice;
            if(Math.random() > 0.25) choice = moves[Math.floor(Math.random()*moves.length)];
            else {
                let best = Infinity;
                moves.forEach(m => {
                    const nb = [...engine.board]; engine.execInternal(m, nb);
                    const val = engine.minimax(2, -10000, 10000, true, nb);
                    if(val < best) { best = val; choice = m; }
                });
            }
            engine.move(choice);
            render();
        }

        function updateAdvisor() {
            const score = engine.eval();
            const wPct = Math.min(Math.max(50 + (score * 5), 5), 95);
            document.getElementById('eval-w').style.width = wPct + '%';
            document.getElementById('eval-b').style.width = (100 - wPct) + '%';
            document.getElementById('eval-text').innerText = `Analisis: ${score > 0 ? '+' : ''}${score.toFixed(1)} (${score > 1.5 ? 'Putih Dominan' : score < -1.5 ? 'Hitam Dominan' : 'Netral'})`;

            // Ancaman
            const threats = [];
            for(let i=0; i<64; i++) if(engine.getColor(engine.board[i])==='white' && engine.isAttacked(i, 'black', engine.board)) threats.push(getPos(i));
            document.getElementById('threat-log').innerText = threats.length > 0 ? `Bidak di ${threats.join(', ')} terancam!` : "Pertahanan aman.";

            // Saran Langkah
            const suggestions = [];
            for(let i=0; i<64; i++) {
                if(engine.getColor(engine.board[i]) === 'white') {
                    engine.getMoves(i).forEach(m => {
                        const nb = [...engine.board]; engine.execInternal(m, nb);
                        suggestions.push({ m, val: engine.minimax(3, -10000, 10000, false, nb) });
                    });
                }
            }
            suggestions.sort((a,b) => b.val - a.val);
            
            const list = document.getElementById('suggestion-list');
            list.innerHTML = '';
            suggestions.slice(0, 3).forEach((s, idx) => {
                const box = document.createElement('div');
                box.className = `suggestion-box ${activeSuggestion && activeSuggestion.from === s.m.from && activeSuggestion.to === s.m.to ? 'active' : ''}`;
                const piece = engine.getType(engine.board[s.m.from]);
                box.innerHTML = `<strong>#${idx+1} ${piece} ${getPos(s.m.from)} â†’ ${getPos(s.m.to)}</strong><br><small>Target: Menyerang Bot AI</small>`;
                box.onclick = () => { activeSuggestion = s.m; document.getElementById('btn-execute').style.display = 'block'; render(); };
                list.appendChild(box);
            });
        }

        function executeSuggested() {
            if(activeSuggestion) {
                engine.move(activeSuggestion);
                activeSuggestion = null;
                document.getElementById('btn-execute').style.display = 'none';
                render();
            }
        }

        function getPos(i) { return 'abcdefgh'[i%8] + (8-Math.floor(i/8)); }
        function resetGame() { if(confirm("Mulai ulang?")) { engine.reset(); render(); } }

        window.onload = render;
    </script>
</body>
</html>
